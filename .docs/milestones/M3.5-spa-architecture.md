# Milestone 3.5: SPA Architecture Migration

**Status**: ✅ Completed  
**Date Started**: 2025-12-05  
**Date Completed**: 2025-12-06

## Overview

Milestone ini fokus pada migrasi dari template-based approach (Go templates dengan Vue CDN) ke SPA (Single Page Application) architecture. Frontend dan backend akan dipisahkan dengan jelas dalam satu codebase, dengan frontend sebagai SPA yang berkomunikasi dengan backend melalui REST API.

## Objectives

1. Setup frontend SPA dengan Vue 3 + Vite (sudah ada)
2. Konfigurasi API communication layer
3. Setup static file serving untuk production
4. Konfigurasi development workflow (dev server + proxy)
5. Migrasi dari template-based ke SPA routing

## Deliverables

### Frontend Setup

- Frontend project structure (sudah ada)
- Setup API client dengan ofetch atau ky
- Setup Pinia stores untuk state management
- Setup Vue Router untuk client-side routing
- Setup PrimeVue untuk UI components
- Setup utilities (@vueuse/core, date-fns)

### Backend API Layer

- Convert template handlers ke JSON API handlers
- Setup API response format yang konsisten
- Setup API error handling
- Update CORS configuration untuk SPA

### Static File Serving

- Setup Go server untuk serve static files dari frontend build
- Setup fallback routing untuk SPA (semua routes serve index.html)
- Konfigurasi build output directory

### Development Workflow

- Setup Vite dev server dengan proxy ke backend
- Update Makefile untuk frontend commands
- Setup environment variables untuk API URL

## Tech Stack

### Core (sudah ada)

- **Vue 3** - Progressive JavaScript framework
- **TypeScript** - Type-safe JavaScript
- **Vite** - Fast build tool
- **Pinia** - State management
- **Vue Router** - Client-side routing
- **Vitest** - Unit testing

### Rekomendasi Tambahan

1. **PrimeVue** - Enterprise-grade UI components

   ```bash
   pnpm add primevue primeicons
   ```

   - Comprehensive UI component library
   - Built-in icons (tidak perlu icon library terpisah)
   - Form validation built-in (tidak perlu vee-validate)
   - Theming system (tidak perlu Tailwind CSS)

2. **HTTP Client** - Pilih salah satu:

   **Option A: ofetch**

   ```bash
   pnpm add ofetch
   ```

   - Auto-retry logic
   - Type-safe responses
   - Built on Fetch API
   - Lightweight

   **Option B: ky**

   ```bash
   pnpm add ky
   ```

   - Tiny and elegant HTTP client
   - Built on Fetch API
   - Retry mechanism
   - TypeScript support

3. **@vueuse/core** - Composition utilities

   ```bash
   pnpm add @vueuse/core
   ```

   - Essential Vue composition utilities
   - useFetch, useStorage, useEventListener, dll

4. **date-fns** - Modern date utility library

   ```bash
   pnpm add date-fns
   ```

   - Modular and lightweight
   - Immutable & pure functions
   - TypeScript support

5. **Drag & Drop** - Untuk Kanban board
   ```bash
   pnpm add @dnd-kit/core @dnd-kit/sortable
   ```
   - Modern drag & drop toolkit
   - Accessible
   - Performant

### Tidak Diperlukan

- ❌ **Tailwind CSS** - PrimeVue sudah include theming system
- ❌ **Icon Libraries** (@heroicons, @iconify) - PrimeVue sudah include PrimeIcons
- ❌ **vee-validate** - PrimeVue components sudah include form validation
- ❌ **axios** - Diganti dengan ofetch atau ky (lebih modern)

## Files Structure

### Frontend Structure

```
frontend/
├── src/
│   ├── api/              # API client setup
│   │   ├── client.ts     # HTTP client configuration
│   │   └── types.ts      # API response types
│   ├── stores/           # Pinia stores
│   │   └── auth.ts       # Authentication store
│   ├── router/           # Vue Router
│   │   └── index.ts      # Route definitions
│   ├── views/            # Page components
│   │   ├── Landing.vue
│   │   ├── Login.vue
│   │   ├── Register.vue
│   │   └── Dashboard.vue
│   ├── components/       # Reusable components
│   ├── composables/      # Composition functions
│   ├── utils/            # Utility functions
│   ├── types/            # TypeScript types
│   ├── App.vue
│   └── main.ts
├── public/
├── vite.config.ts        # Vite config dengan proxy
├── tsconfig.json
└── package.json
```

### Backend Modifications

```
internal/
├── handlers/
│   ├── api/              # API handlers (JSON responses)
│   │   └── auth.go       # Auth API handlers
│   └── static.go         # Static file serving
└── server/
    └── server.go         # Update routes untuk SPA
```

## Technical Decisions

1. **SPA Architecture**:

   - Frontend: Vue 3 SPA dengan client-side routing
   - Backend: REST API dengan JSON responses
   - Communication: HTTP dengan cookies untuk authentication

2. **Development**:

   - Frontend dev server: `localhost:5173` (Vite)
   - Backend server: `localhost:8080`
   - Vite proxy untuk `/api/*` ke backend

3. **Production**:

   - Build frontend → output ke `frontend/dist/`
   - Go server serve static files dari embedded FS atau direktori
   - Fallback routing untuk SPA (semua routes serve `index.html`)

4. **API Communication**:

   - HTTP client (ofetch/ky) dengan `credentials: 'include'` untuk cookies
   - Standardized API response format
   - Error handling dengan proper status codes

5. **Authentication**:
   - Cookie-based sessions (tetap seperti sekarang)
   - Frontend check auth status via `/api/auth/me`
   - Protected routes dengan Vue Router navigation guards

## API Response Format

### Success Response

```typescript
interface ApiSuccessResponse<T> {
  success: true;
  data: T;
  error: null;
}
```

Example:

```json
{
  "success": true,
  "data": {
    "id": "123",
    "email": "user@example.com",
    "name": "John Doe"
  },
  "error": null
}
```

### Error Response

```typescript
interface ApiErrorResponse {
  success: false;
  data: null;
  error: {
    message: string;
    code: string;
    details?: any;
  };
}
```

Example:

```json
{
  "success": false,
  "data": null,
  "error": {
    "message": "Invalid email or password",
    "code": "AUTH_INVALID_CREDENTIALS"
  }
}
```

## API Client Setup

### Using ofetch

```typescript
// src/api/client.ts
import { ofetch } from "ofetch";

export const apiClient = ofetch.create({
  baseURL: import.meta.env.VITE_API_URL || "/api",
  credentials: "include",
  retry: 1,
  onResponseError({ response }) {
    // Handle errors globally
    console.error("API Error:", response._data);
  },
});
```

### Using ky

```typescript
// src/api/client.ts
import ky from "ky";

export const apiClient = ky.create({
  prefixUrl: import.meta.env.VITE_API_URL || "/api",
  credentials: "include",
  retry: {
    limit: 1,
  },
  hooks: {
    afterResponse: [
      async (request, options, response) => {
        if (!response.ok) {
          const error = await response.json();
          console.error("API Error:", error);
        }
      },
    ],
  },
});
```

## Development Setup

### Vite Proxy Configuration

```typescript
// frontend/vite.config.ts
import { fileURLToPath, URL } from "node:url";
import { defineConfig } from "vite";
import vue from "@vitejs/plugin-vue";

export default defineConfig({
  plugins: [vue()],
  resolve: {
    alias: {
      "@": fileURLToPath(new URL("./src", import.meta.url)),
    },
  },
  server: {
    port: 5173,
    proxy: {
      "/api": {
        target: "http://localhost:8080",
        changeOrigin: true,
      },
    },
  },
});
```

### Environment Variables

```bash
# frontend/.env.development
VITE_API_URL=http://localhost:8080/api

# frontend/.env.production
VITE_API_URL=/api
```

### Development Workflow

#### Terminal 1: Backend Server

```bash
make dev  # Runs on localhost:8080
```

#### Terminal 2: Frontend Dev Server

```bash
cd frontend
pnpm dev  # Runs on localhost:5173
```

Access application at: `http://localhost:5173`

## Production Build

### Build Frontend

```bash
cd frontend
pnpm build  # Output to frontend/dist/
```

### Go Server Configuration

Update `internal/server/server.go` untuk serve static files:

```go
// Serve static files from frontend build
fs := http.FileServer(http.Dir("frontend/dist"))
s.router.Handle("/*", http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
    // Check if file exists
    if _, err := os.Stat("frontend/dist" + r.URL.Path); err == nil {
        fs.ServeHTTP(w, r)
        return
    }

    // Fallback to index.html for SPA routing
    http.ServeFile(w, r, "frontend/dist/index.html")
}))
```

### Update Makefile

```makefile
# Frontend commands
.PHONY: frontend-dev frontend-build frontend-install

frontend-install:
	cd frontend && pnpm install

frontend-dev:
	cd frontend && pnpm dev

frontend-build:
	cd frontend && pnpm build

# Build all (backend + frontend)
build-all: frontend-build build
```

## Migration Steps

1. ✅ Setup frontend project structure (sudah ada)
2. Install dependencies (PrimeVue, ofetch/ky, @vueuse/core, date-fns, drag & drop)
3. Setup API client layer
4. Setup PrimeVue configuration
5. Convert auth handlers to API endpoints (`internal/handlers/api/auth.go`)
6. Setup static file serving in Go (`internal/handlers/static.go`)
7. Setup Vue Router dengan routes (Landing, Login, Register, Dashboard)
8. Create initial views
9. Setup Pinia auth store
10. Setup router guards untuk protected routes
11. Update development workflow
12. Test development dan production builds
13. Update dokumentasi (README, deployment guide)

## PrimeVue Setup

### Installation

```bash
cd frontend
pnpm add primevue primeicons
```

### Configuration

```typescript
// src/main.ts
import { createApp } from "vue";
import { createPinia } from "pinia";
import PrimeVue from "primevue/config";
import "primevue/resources/themes/lara-light-blue/theme.css";
import "primevue/resources/primevue.min.css";
import "primeicons/primeicons.css";

import App from "./App.vue";
import router from "./router";

const app = createApp(App);

app.use(createPinia());
app.use(router);
app.use(PrimeVue);

app.mount("#app");
```

## Next Steps

Setelah milestone ini selesai, langkah selanjutnya adalah:

1. **Milestone 4: Authentication dengan SPA** - Implement login/register dengan SPA approach
2. **Milestone 5: Projects CRUD dengan SPA** - Implement project management dengan SPA

## Notes

- Template-based approach (M3) akan di-deprecate setelah migrasi selesai
- Frontend dan backend sekarang memiliki konteks yang terpisah dengan jelas
- Development workflow lebih familiar dengan modern frontend tooling
- Production deployment tetap sederhana (satu binary serve static + API)
- PrimeVue menyediakan comprehensive UI solution, tidak perlu library tambahan untuk styling
- ofetch atau ky lebih modern dan lightweight dibanding axios

## Testing

### Development

```bash
# Terminal 1: Backend
make dev

# Terminal 2: Frontend
cd frontend && pnpm dev

# Access: http://localhost:5173
```

### Production Build

```bash
# Build frontend
cd frontend && pnpm build

# Build backend
make build

# Run
./bin/vugo

# Access: http://localhost:8080
```

## References

- [Vue 3 Documentation](https://vuejs.org/)
- [Vite Documentation](https://vitejs.dev/)
- [Vue Router](https://router.vuejs.org/)
- [Pinia](https://pinia.vuejs.org/)
- [PrimeVue](https://primevue.org/)
- [ofetch](https://github.com/unjs/ofetch)
- [ky](https://github.com/sindresorhus/ky)
- [@vueuse/core](https://vueuse.org/)
- [date-fns](https://date-fns.org/)
- [@dnd-kit](https://dndkit.com/)
